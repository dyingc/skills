# GDB 脚本死锁预防

## 目录
- [常见死锁场景](#常见死锁场景)
- [命令失败级联](#命令失败级联)
- [脚本设计准则](#脚本设计准则)
- [测试清单](#测试清单)
- [死锁恢复](#死锁恢复)

## 常见死锁场景

**重要**: GDB 脚本以非交互模式运行。死锁特别严重因为:
- 无法交互式恢复
- 脚本可能无限挂起
- 会话状态变得不可预测

### 1. `until` 无法到达的地址

```gdb
until 0x12345678  # 若地址永远不会到达则死锁！
```

- **预防**: 先验证地址在执行路径上
- **替代方案**: 使用 `break <addr>; continue`

### 2. `finish` 在问题函数中

```gdb
finish  # 在 main() 或调用 exit() 的函数中死锁！
```

- **高风险**: `main()`、调用 `exit()`/`_exit()` 的函数、信号处理函数
- **预防**: 使用 `continue` 到下一个断点
- **测试**: 脚本化前先交互式测试 `finish`

### 3. `continue` 无可达断点

```gdb
continue  # 若无断点或死循环则永远运行！
```

- **预防**: 确保至少有一个可达断点
- **验证**: `continue` 前用 `info breakpoints` 列出断点

### 4. 永不触发的条件断点

```gdb
break *0x12345678 if $rax == 999999  # 可能永不触发！
continue
```

- **预防**: 先交互式测试条件
- **替代方案**: 使用无条件断点 + 手动条件检查

### 5. 需要输入的命令

```gdb
run  # 等待 stdin 输入时死锁
```

- **预防**: 始终通过文件提供输入: `run < input.txt` 或 `set args < input.txt`

## 命令失败级联

```gdb
# 风险: 若程序在 continue 后退出，后续命令被跳过
continue
x/s $rdi  # 程序退出则不执行

# 更安全: continue 后检查是否仍在运行
continue
if $_inferior == 0
  echo [!] 程序意外退出\n
else
  echo [+] 程序运行中\n
  x/s $rdi
end
```

使用 `$_inferior` 便捷变量:
- `0`: 无下级进程（程序退出或未启动）
- 非零: 下级进程运行中

## 脚本设计准则

### 1. 执行前先设置断点

```gdb
# 正确: 先设置断点
break *0x12345678
run < input.txt
continue
```

### 2. 脚本中避免 `until`

```gdb
# 避免
until 0x12345678

# 推荐
break *0x12345678
continue
```

### 3. 脚本中避免 `finish`

```gdb
# 避免
finish

# 推荐
break *0x12345678  # 在返回后设置断点
continue
```

### 4. 始终提供程序输入

```gdb
# 避免
run

# 推荐
run < input.txt
# 或
run < /dev/null
```

## 测试清单

脚本定稿前检查:
- [ ] 每条命令都已交互式测试
- [ ] 完整序列已交互式测试（通过独立 MCP 调用）
- [ ] 确认脚本中无 `until` 命令
- [ ] 确认脚本中无 `finish` 命令（除非已测试）
- [ ] 确认所有断点在执行前设置
- [ ] 确认读取 stdin 的程序已提供输入

## 死锁恢复

脚本挂起时:
1. 终止整个 GDB 会话（MCP: `close_session` 或 `gdb_terminate`）
2. 启动全新会话
3. 分析死锁原因（检查日志文件）
4. 修复脚本中的问题
5. 从逐命令验证重新开始

## 安全命令 vs 风险命令

| 命令 | 风险等级 | 说明 |
|------|----------|------|
| `break` | 安全 | 设置断点 |
| `info` | 安全 | 查看状态 |
| `print` | 安全 | 计算表达式 |
| `x` | 安全 | 查看内存 |
| `stepi` | 低 | 单指令步进 |
| `nexti` | 低 | 单指令步过 |
| `continue` | 中 | 需要可达断点 |
| `finish` | 高 | 可能在 main/exit 中挂起 |
| `until` | 高 | 可能永不到达目标 |
| `run` | 中 | 无输入时可能挂起 |
